name: Publish to Dev.to

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'blog/content/posts/*.md'
      - .github/workflows/publish-devto.yml

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install python-frontmatter requests tomli

      - name: Publish changed posts to Dev.to
        env:
          DEV_TO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}
        run: |
          import os
          import sys
          import glob
          import frontmatter
          import requests
          import json

          api_key = os.environ.get('DEV_TO_API_KEY')
          if not api_key:
              print('ERROR: DEV_TO_API_KEY secret not set')
              sys.exit(1)

          # Find all blog posts
          posts = glob.glob('blog/content/posts/*.md')
          posts = [p for p in posts if not p.endswith('_index.md')]

          if not posts:
              print('No posts found')
              sys.exit(0)

          for post_path in posts:
              print(f'Processing {post_path}...')

              with open(post_path, 'r', encoding='utf-8') as f:
                  post = frontmatter.load(f, handler=frontmatter.TOMLHandler())

              # Debug: Print metadata structure
              print(f'  Metadata keys: {list(post.metadata.keys())}')
              if 'extra' in post.metadata:
                  print(f'  Extra keys: {list(post.metadata["extra"].keys())}')

              # Skip posts without required fields
              if 'published' in post.metadata and post.metadata['published']:
                  print(f'  Skipping {post.metadata.get("title", post_path)} (already published)')
                  continue

              # Get extra fields
              extra = post.metadata.get('extra', {})
              canonical_url = extra.get('canonical_url') or post.metadata.get('canonical_url', '')

              if not canonical_url:
                  print(f'  Debug - Extra: {extra}')
                  print(f'  Skipping {post.metadata.get("title", post_path)} (no canonical_url)')
                  continue

              title = post.metadata.get('title', 'Untitled')
              description = post.metadata.get('description', '')
              author = extra.get('author', '')
              tags = post.metadata.get('tags', [])

              # Prepare article payload
              article = {
                  'title': title,
                  'description': description,
                  'body_markdown': post.content,
                  'published': False,
                  'canonical_url': canonical_url,
                  'tags': tags[:4] if tags else []  # Dev.to limits to 4 tags
              }

              payload = {'article': article}

              # POST to Dev.to
              headers = {
                  'api-key': api_key,
                  'Content-Type': 'application/json'
              }

              try:
                  response = requests.post(
                      'https://dev.to/api/articles',
                      json=payload,
                      headers=headers,
                      timeout=10
                  )

                  if response.status_code == 201:
                      data = response.json()
                      print(f'  ✓ Published as draft: {data.get("url", "https://dev.to/dashboard")}')
                  else:
                      print(f'  ✗ Error {response.status_code}: {response.text}')

              except Exception as e:
                  print(f'  ✗ Failed: {e}')
        shell: python
