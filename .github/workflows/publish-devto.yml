name: Publish to Dev.to

on:
  push:
    branches: [main]
    paths:
      - 'blog/content/posts/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: blog/content/posts/**/*.md

      - name: Publish to Dev.to
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          DEVTO_TOKEN: ${{ secrets.DEV_TO_API_KEY }}
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" == blog/content/posts/* ]] && [[ "$file" != *"_index.md" ]]; then
              echo "Processing $file..."

              # Extract frontmatter using awk for robustness
              title=$(awk -F'"' '/^title = "/ {print $2}' "$file")
              description=$(awk -F'"' '/^description = "/ {print $2}' "$file")
              canonical_url=$(awk -F'"' '/^canonical_url = "/ {print $2}' "$file")

              # Extract tags from frontmatter
              tags=$(sed -n '/^tags = \[/,/^\]/p' "$file" | sed 's/tags = \[//;s/\]//' | sed 's/"//g' | sed 's/, /,/g')

              # Extract body markdown (everything after the closing +++)
              body=$(awk '/^[+]{3}$/ {flag++; next} flag==2' "$file" | jq -Rs .)

              # Create JSON payload with proper escaping
              json_payload=$(jq -n \
                --arg title "$title" \
                --arg description "$description" \
                --arg body_markdown "$body" \
                --arg canonical_url "$canonical_url" \
                --arg tags "$tags" \
                '{article: {title: $title, description: $description, body_markdown: $body_markdown, published: false, tags: ($tags | split(",")), canonical_url: $canonical_url}}')

              # Publish to Dev.to
              echo "Publishing '$title' to Dev.to..."
              curl -X POST https://dev.to/api/articles \
                -H "api-key: $DEVTO_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$json_payload" \
                -w "\nStatus: %{http_code}\n"
            fi
          done
